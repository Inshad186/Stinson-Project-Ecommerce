<%- include("../admin/adminLayouts/header") %>

  <style>
    .image-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .image-wrapper {
      position: relative;
      display: inline-block;
    }

    .image-wrapper img {
      width: 100px;
      height: 100px;
      object-fit: cover;
    }

    .remove-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: red;
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
    }
  </style>

  <body>

    <!--start wrapper-->
    <div class="wrapper">

      <!--start sidebar -->
      <aside class="sidebar-wrapper" data-simplebar="true">
        <div class="sidebar-header">
          <div>
            <img src="assets/images/logo-icon-2.png" class="logo-icon" alt="logo icon">
          </div>
          <div>
            <h4 class="logo-text">Fobia</h4>
          </div>
        </div>
        <!--navigation-->
        <ul class="metismenu" id="menu">
          <li>
            <a href="/admin/dashboard">
              <div class="parent-icon">
                <ion-icon name="home-outline"></ion-icon>
              </div>
              <div class="menu-title">Dashboard</div>
            </a>
          </li>
          <li>
            <a href="javascript:;" class="has-arrow">
              <div class="parent-icon">
                <ion-icon name="bag-handle-outline"></ion-icon>
              </div>
              <div class="menu-title">ecommerce</div>
            </a>
            <ul>
              <li><a href="/admin/userList">
                  <ion-icon name="ellipse-outline"></ion-icon>User List
                </a>
              </li>
              <li><a href="/admin/categoryList">
                  <ion-icon name="ellipse-outline"></ion-icon>Categories
                </a>
              </li>
              <li><a href="/admin/productList">
                  <ion-icon name="ellipse-outline"></ion-icon>Products
                </a>
              </li>
              <li><a href="/admin/order">
                  <ion-icon name="ellipse-outline"></ion-icon>Orders List
                </a>
              </li>
              <li><a href="/admin/coupons">
                  <ion-icon name="ellipse-outline"></ion-icon>Coupon List
                </a>
              </li>
              <li><a href="/admin/offer">
                  <ion-icon name="ellipse-outline"></ion-icon>Offer List
                </a>
              </li>
            </ul>
          </li>
          <li class="menu-label">UI Elements</li>
          <li>
            <a href="javascript:;" class="has-arrow">
              <div class="parent-icon">
                <ion-icon name="briefcase-outline"></ion-icon>
              </div>
              <div class="menu-title">Users</div>
            </a>
            <ul>
              <li><a href="/admin/userList">
                  <ion-icon name="ellipse-outline"></ion-icon>User List
                </a>
              </li>
            </ul>
          </li>

          <li>
            <a class="has-arrow" href="javascript:;">
              <div class="parent-icon">
                <ion-icon name="gift-outline"></ion-icon>
              </div>
              <div class="menu-title">Categories</div>
            </a>
            <ul>
              <li><a href="/admin/categoryList">
                  <ion-icon name="ellipse-outline"></ion-icon>Categories
              </li>
              <li><a href="/admin/addCategory">
                  <ion-icon name="ellipse-outline"></ion-icon>Add Category
              </li>
            </ul>
            </a>
          </li>
          <li>
            <a class="has-arrow" href="javascript:;">
              <div class="parent-icon">
                <ion-icon name="leaf-outline"></ion-icon>
              </div>
              <div class="menu-title">Products</div>
            </a>
            <ul>
              <li><a href="/admin/productList">
                  <ion-icon name="ellipse-outline"></ion-icon>Products
              </li>
              <li><a href="/admin/addProduct">
                  <ion-icon name="ellipse-outline"></ion-icon>Add Product
              </li>
            </ul>
            </a>
          </li>
          <li>
            <a class="has-arrow" href="javascript:;">
              <div class="parent-icon">
                <ion-icon name="gift-outline"></ion-icon>
              </div>
              <div class="menu-title">Orders</div>
            </a>
              <ul>
                <li><a href="/admin/order">
                  <ion-icon name="ellipse-outline"></ion-icon>Orders List
                </li>
              </ul>
            </a>
          </li>
          <li>
            <a class="has-arrow" href="javascript:;">
              <div class="parent-icon">
                <ion-icon name="gift-outline"></ion-icon>
              </div>
              <div class="menu-title">Coupons</div>
            </a>
              <ul>
                <li><a href="/admin/coupons">
                  <ion-icon name="ellipse-outline"></ion-icon>Coupon List
                </li>
              </ul>
            </a>
          </li>
          <li>
            <a class="has-arrow" href="javascript:;">
              <div class="parent-icon">
                <ion-icon name="gift-outline"></ion-icon>
              </div>
              <div class="menu-title">Offer</div>
            </a>
              <ul>
                <li><a href="/admin/offer">
                  <ion-icon name="ellipse-outline"></ion-icon>Offer List
                </li>
              </ul>
            </a>
          </li>
          <li>
            <a class="has-arrow" href="javascript:;">
              <div class="parent-icon">
                <ion-icon name="gift-outline"></ion-icon>
              </div>
              <div class="menu-title">Sales Report</div>
            </a>
              <ul>
                <li><a href="/admin/salesReport">
                  <ion-icon name="ellipse-outline"></ion-icon>Report
                </li>
              </ul>
            </a>
          </li>
        </ul>
        <!--end navigation-->
      </aside>
      <!--end sidebar -->

      <!--start top header-->
      <header class="top-header">
        <nav class="navbar navbar-expand gap-3">
          <div class="toggle-icon">
            <ion-icon name="menu-outline"></ion-icon>
          </div>
          <div class="top-navbar-right ms-auto">

            <ul class="navbar-nav align-items-center">
              <li class="nav-item dropdown dropdown-user-setting">
                <a class="nav-link dropdown-toggle dropdown-toggle-nocaret" href="javascript:;"
                  data-bs-toggle="dropdown">
                  <div class="user-setting">
                    <img src="assets/images/avatars/06.png" class="user-img" alt="">
                  </div>
                </a>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li>
                    <a class="dropdown-item" href="javascript:;">
                      <div class="d-flex flex-row align-items-center gap-2">
                        <img src="assets/images/avatars/06.png" alt="" class="rounded-circle" width="54" height="54">
                        <div class="">
                          <h6 class="mb-0 dropdown-user-name">Inshad</h6>
                          <small class="mb-0 dropdown-user-designation text-secondary">Mern Stack</small>
                        </div>
                      </div>
                    </a>
                  </li>
                  <li>
                    <hr class="dropdown-divider">
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </nav>
      </header>
      <!--end top header-->


      <!-- start page content wrapper-->
      <div class="page-content-wrapper">
        <!-- start page content-->
        <div class="page-content">

          <!--start breadcrumb-->
          <div class="page-breadcrumb d-none d-sm-flex align-items-center mb-3">
            <div class="breadcrumb-title pe-3">Dashboard</div>
            <div class="ps-3">
              <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0 p-0 align-items-center">
                  <li class="breadcrumb-item"><a href="javascript:;">
                      <ion-icon name="home-outline"></ion-icon>
                    </a>
                  </li>
                  <li class="breadcrumb-item active" aria-current="page">User Details</li>
                </ol>
              </nav>
            </div>
          </div>
          <!--end breadcrumb-->


          <div class="container d-flex justify-content-center align-items-center min-vh-100">
            <div class="card w-100" style="max-width: 600px;">
              <div class="card-body p-4 d-flex flex-column justify-content-center align-items-center">
                <h5 class="card-title">Add New Category</h5>
                <hr class="w-100" />
                <form id="form-body" enctype="multipart/form-data">
                  <div class="form-body mt-4 w-100">
                    <div class="row">
                      <div class="col-12">
                        <div class="border border-3 p-4 rounded d-flex flex-column align-items-center">
                          <div class="mb-3 w-100">
                            <label for="inputCategoryTitle" class="form-label">Category Title</label>
                            <input name="name" type="text" class="form-control" id="Categoryname"
                              placeholder="Enter category title" required>
                            <div id="name-error" class="text-danger"></div>
                          </div>
                          <div class="mb-3 w-100">
                            <label for="inputProductDescription" class="form-label">Description</label>
                            <textarea name="description" class="form-control" id="CategoryDescription" rows="3"
                              required></textarea>
                            <div id="description-error" class="text-danger"></div>
                          </div>
                          <div class="mb-3 w-100">
                            <label for="inputProductDescription" class="form-label">Category Images</label>
                            <input name="image" id="image-uploadify" type="file" accept=".png,.jpeg,.jpg" required>
                            <div class="mt-2">
                              <img id="image-preview" style="max-width: 100%; display: none;">
                            </div>
                            <input type="hidden" name="croppedImage" id="croppedImage">
                          </div>
                        </div>
                      </div>
                      <div class="col-12 d-flex justify-content-center mt-3">
                        <button type="submit" class="btn btn-primary">Save Category</button>
                      </div>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">
          <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>

          <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

          <script>
            document.addEventListener("DOMContentLoaded", function () {
              let cropper;
              const imageUpload = document.getElementById('image-uploadify');
              const imagePreview = document.getElementById('image-preview');
              const croppedImageInput = document.getElementById('croppedImage');

              imageUpload.addEventListener('change', function (event) {
                const files = event.target.files;
                if (files && files.length > 0) {
                  const file = files[0];
                  const reader = new FileReader();
                  reader.onload = function (e) {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                    if (cropper) {
                      cropper.destroy();
                    }
                    cropper = new Cropper(imagePreview, {
                      aspectRatio: 1, // Set your aspect ratio here
                      viewMode: 1,
                      autoCropArea: 1,
                      cropBoxResizable: false,
                      crop(event) {
                        const canvas = cropper.getCroppedCanvas();
                        croppedImageInput.value = canvas.toDataURL('image/jpeg');
                      }
                    });
                  };
                  reader.readAsDataURL(file);
                }
              });

              document.getElementById("form-body").addEventListener("submit", async function (event) {
                event.preventDefault();

                const name = document.getElementById('Categoryname').value;
                const description = document.getElementById('CategoryDescription').value;
                const image = document.getElementById('image-uploadify').files[0];

                // Regular expressions for validation
                const nameRegex = /^[^\s][a-zA-Z\s]*[^\s]$/;
                const descriptionRegex = /^[^\s].*[^\s]$/; // Ensure it is not empty and does not start/end with whitespace

                let isValid = true;

                // Validation checks
                if (!nameRegex.test(name)) {
                  showError('name-error', "Category name can only contain letters and spaces.");
                  isValid = false;
                } else {
                  hideError('name-error');
                }

                if (!descriptionRegex.test(description)) {
                  showError('description-error', 'Please enter a valid description.');
                  isValid = false;
                } else {
                  hideError('description-error');
                }

                if (!image) {
                  showError('image-error', 'Please upload an image.');
                  isValid = false;
                } else {
                  hideError('image-error');
                }

                if (isValid) {
                  const formData = new FormData(event.target);

                  try {
                    const response = await fetch("/admin/addCategory", {
                      method: "POST",
                      body: formData
                    });
                    const data = await response.json();

                    if (data.success) {
                      await Swal.fire({
                        title: "Added",
                        text: "Category added successfully",
                        icon: "success"
                      });
                      window.location.href = "/admin/categoryList";
                    } else {
                      await Swal.fire({
                        title: "Category already exists",
                        text: "Please try with a different name.",
                        icon: "error"
                      });
                    }

                  } catch (error) {
                    console.error(error.message);
                  }
                }
              });

              function showError(id, message) {
                const errorElement = document.getElementById(id);
                if (errorElement) {
                    errorElement.textContent = message;
                }
              }

              function hideError(id) {
                const errorElement = document.getElementById(id);
                if (errorElement) {
                    errorElement.textContent = '';
                }
            }

              document.getElementById('image-uploadify').addEventListener('change', function (event) {
                const files = event.target.files;
                const imageContainer = document.getElementById('image-container');
                imageContainer.innerHTML = ''; // Clear previous images

                Array.from(files).forEach(file => {
                  const reader = new FileReader();
                  reader.onload = function (e) {
                    const imageWrapper = document.createElement('div');
                    imageWrapper.classList.add('image-wrapper');

                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.alt = file.name;

                    const removeBtn = document.createElement('button');
                    removeBtn.classList.add('remove-btn');
                    removeBtn.textContent = 'X';
                    removeBtn.onclick = () => imageWrapper.remove();

                    imageWrapper.appendChild(img);
                    imageWrapper.appendChild(removeBtn);
                    imageContainer.appendChild(imageWrapper);
                  };
                  reader.readAsDataURL(file);
                });
              });
            });
          </script>




          <!--start footer-->
          <footer class="footer">
            <div class="footer-text">
              Copyright © 2023. All right reserved.
            </div>
          </footer>
          <!--end footer-->


          <!--Start Back To Top Button-->
          <a href="javaScript:;" class="back-to-top">
            <ion-icon name="arrow-up-outline"></ion-icon>
          </a>
          <!--End Back To Top Button-->

          <!--start switcher-->
          <div class="switcher-body">
            <button class="btn btn-primary btn-switcher shadow-sm" type="button" data-bs-toggle="offcanvas"
              data-bs-target="#offcanvasScrolling" aria-controls="offcanvasScrolling">
              <ion-icon name="color-palette-outline" class="me-0"></ion-icon>
            </button>
            <div class="offcanvas offcanvas-end shadow border-start-0 p-2" data-bs-scroll="true"
              data-bs-backdrop="false" tabindex="-1" id="offcanvasScrolling">
              <div class="offcanvas-header border-bottom">
                <h5 class="offcanvas-title" id="offcanvasScrollingLabel">Theme Customizer</h5>
                <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
              </div>
              <div class="offcanvas-body">
                <h6 class="mb-0">Theme Variation</h6>
                <hr>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="inlineRadioOptions" id="LightTheme" value="option1"
                    checked>
                  <label class="form-check-label" for="LightTheme">Light</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="inlineRadioOptions" id="DarkTheme" value="option2">
                  <label class="form-check-label" for="DarkTheme">Dark</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="inlineRadioOptions" id="SemiDark" value="option3">
                  <label class="form-check-label" for="SemiDark">Semi Dark</label>
                </div>
                <hr />
                <h6 class="mb-0">Header Colors</h6>
                <hr />
                <div class="header-colors-indigators">
                  <div class="row row-cols-auto g-3">
                    <div class="col">
                      <div class="indigator headercolor1" id="headercolor1"></div>
                    </div>
                    <div class="col">
                      <div class="indigator headercolor2" id="headercolor2"></div>
                    </div>
                    <div class="col">
                      <div class="indigator headercolor3" id="headercolor3"></div>
                    </div>
                    <div class="col">
                      <div class="indigator headercolor4" id="headercolor4"></div>
                    </div>
                    <div class="col">
                      <div class="indigator headercolor5" id="headercolor5"></div>
                    </div>
                    <div class="col">
                      <div class="indigator headercolor6" id="headercolor6"></div>
                    </div>
                    <div class="col">
                      <div class="indigator headercolor7" id="headercolor7"></div>
                    </div>
                    <div class="col">
                      <div class="indigator headercolor8" id="headercolor8"></div>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>
          <!--end switcher-->


          <!--start overlay-->
          <div class="overlay nav-toggle-icon"></div>
          <!--end overlay-->

        </div>
        <!--end wrapper-->


        <!-- JS Files-->
        <script src="assets/js/jquery.min.js"></script>
        <script src="assets/plugins/simplebar/js/simplebar.min.js"></script>
        <script src="assets/plugins/metismenu/js/metisMenu.min.js"></script>
        <script src="assets/js/bootstrap.bundle.min.js"></script>
        <script type="module" src="../../../../unpkg.com/ionicons%405.5.2/dist/ionicons/ionicons.esm.js"></script>
        <!--plugins-->
        <script src="assets/plugins/perfect-scrollbar/js/perfect-scrollbar.js"></script>
        <script src="assets/plugins/apexcharts-bundle/js/apexcharts.min.js"></script>
        <script src="assets/plugins/easyPieChart/jquery.easypiechart.js"></script>
        <script src="assets/plugins/chartjs/chart.min.js"></script>
        <script src="assets/js/index.js"></script>
        <!-- Main JS-->
        <script src="assets/js/main.js"></script>


  </body>

  <%- include("../admin/adminLayouts/footer") %>